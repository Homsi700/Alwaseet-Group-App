
# هيكل مشروع "محاسبي" وشرح مكوناته (بعد التحول إلى Node.js/mssql)

يا شريكتي "حمص (لتطوير البرمجي)"،

هذا المستند يقدم نظرة شاملة ومحدثة على هيكل مشروع "محاسبي" مع شرح لكل جزء رئيسي. المشروع الآن يعتمد كلياً على تقنيات Node.js، Next.js، TypeScript، ويتصل مباشرة بقاعدة بيانات SQL Server باستخدام مكتبة `mssql`.

## أولاً: هيكل المجلدات والملفات الرئيسي

```
.
├── .github/                      # مجلد لإعدادات GitHub (مثل workflows)
│   └── workflows/
│       └── generator-generic-ossf-slsa3-publish.yml
├── .vscode/                      # إعدادات محرر Visual Studio Code
│   └── settings.json             # إعدادات خاصة بالمحرر للمشروع
├── node_modules/                 # (يحتوي على جميع المكتبات والحزم المثبتة - يُدار بواسطة npm)
├── public/                       # (للملفات الثابتة العامة مثل الصور والأيقونات)
├── scripts/                      # مجلد للسكريبتات المساعدة (TypeScript)
│   └── update-admin-password.ts  # سكريبت لتحديث/إنشاء كلمة مرور المدير (يستخدم db.ts الجديد)
├── src/                          # المجلد الرئيسي الذي يحتوي على كود المصدر للتطبيق
│   ├── ai/                       # مجلد خاص بوظائف الذكاء الاصطناعي باستخدام Genkit
│   │   ├── dev.ts                # (ملف لتشغيل وتطوير تدفقات Genkit محلياً - إذا كان مستخدماً)
│   │   └── genkit.ts             # ملف تهيئة وإعداد Genkit الرئيسي للتطبيق
│   ├── app/                      # مجلد أساسي في Next.js App Router، يمثل بنية المسارات (Routes)
│   │   ├── (app)/                # مجموعة مسارات للصفحات الداخلية (بعد تسجيل الدخول، تشترك في تخطيط معين)
│   │   │   ├── backup-restore/
│   │   │   │   └── page.tsx      # صفحة النسخ الاحتياطي والاستعادة
│   │   │   ├── customers/
│   │   │   │   └── page.tsx      # صفحة إدارة العملاء
│   │   │   ├── finance/
│   │   │   │   └── page.tsx      # صفحة الإدارة المالية
│   │   │   ├── inventory/
│   │   │   │   └── page.tsx      # صفحة إدارة المخزون
│   │   │   ├── layout.tsx        # التخطيط الرئيسي للصفحات داخل (app) (يتضمن الشريط الجانبي والرأس)
│   │   │   ├── page.tsx          # الصفحة الرئيسية للتطبيق (لوحة التحكم Dashboard) - المسار '/'
│   │   │   ├── pos/
│   │   │   │   └── page.tsx      # صفحة نقطة البيع السريعة
│   │   │   ├── products/
│   │   │   │   └── page.tsx      # صفحة قائمة المنتجات وإدارتها (قيد التطوير المكثف للربط بالـ API)
│   │   │   ├── purchases/
│   │   │   │   └── page.tsx      # صفحة إدارة المشتريات
│   │   │   ├── reports/
│   │   │   │   └── page.tsx      # صفحة التقارير والتحليلات
│   │   │   ├── sales/
│   │   │   │   └── page.tsx      # صفحة إدارة المبيعات
│   │   │   ├── settings/
│   │   │   │   └── page.tsx      # صفحة إعدادات التطبيق
│   │   │   ├── suppliers/
│   │   │   │   └── page.tsx      # صفحة إدارة الموردين
│   │   │   └── transactions/
│   │   │       └── page.tsx      # صفحة سجل الحركات المالية
│   │   ├── api/                  # مجلد لنقاط النهاية (API Endpoints) الخاصة بالخادم
│   │   │   ├── auth/
│   │   │   │   └── login/
│   │   │   │       └── route.ts  # API لتسجيل الدخول (يستخدم db.ts الجديد ويتصل مباشرة بـ SQL Server)
│   │   │   │   └── register/
│   │   │   │       └── route.ts  # API لتسجيل حساب جديد (يستخدم db.ts الجديد)
│   │   │   ├── categories/       # API للفئات (يستخدم بيانات وهمية حالياً، سيتم ربطه بـ db.ts)
│   │   │   │   ├── [categoryId]/
│   │   │   │   │   └── route.ts
│   │   │   │   └── route.ts
│   │   │   └── products/         # API للمنتجات (يستخدم بيانات وهمية حالياً، سيتم ربطه بـ db.ts)
│   │   │       ├── [productId]/
│   │   │       │   └── route.ts
│   │   │       └── route.ts
│   │   ├── backup-restore/       # (ملف فارغ لتجنب التعارض مع المسار داخل (app))
│   │   │   └── page.tsx
│   │   ├── (بقية المجلدات المشابهة التي تم إفراغها: customers, finance, etc.)
│   │   ├── globals.css           # الأنماط العامة ومتغيرات ShadCN والسمات (فاتح/داكن)
│   │   ├── layout.tsx            # التخطيط الجذري لجميع صفحات التطبيق (يتضمن html, body, AppProviders)
│   │   ├── login/
│   │   │   └── page.tsx          # صفحة تسجيل الدخول (تصميم احترافي، لا تستخدم تخطيط (app))
│   │   └── page.tsx              # الصفحة الرئيسية الموجهة (Redirector Page)
│   ├── components/               # مجلد للمكونات القابلة لإعادة الاستخدام
│   │   ├── layout/               # مكونات خاصة بتخطيط الواجهة
│   │   │   ├── AppLayout.tsx     # المكون الذي يجمع الشريط الجانبي الأيمن والرأس والمحتوى الرئيسي
│   │   │   ├── LanguageToggle.tsx # زر تبديل اللغة (عربي/إنجليزي)
│   │   │   ├── SidebarNav.tsx    # الشريط الجانبي وقائمة التنقل
│   │   │   ├── ThemeToggle.tsx   # زر تبديل الوضع (نهاري/ليلي)
│   │   │   └── nav-items.ts      # تعريف عناصر التنقل للشريط الجانبي ولوحة التحكم
│   │   └── ui/                   # مكونات واجهة المستخدم من ShadCN UI ومكونات مخصصة (IconCard, etc.)
│   ├── hooks/                    # مجلد للـ Custom Hooks (خطافات React مخصصة)
│   │   ├── use-mobile.tsx        # خطاف لمعرفة إذا كان العرض على جهاز محمول
│   │   └── use-toast.ts          # خطاف لإدارة وعرض التنبيهات (Toasts)
│   ├── lib/                      # مجلد للمكتبات المساعدة والوظائف العامة
│   │   ├── auth.ts               # وظائف مساعدة للمصادقة والتحقق من الصلاحيات
│   │   ├── db.ts                 # **وظائف الاتصال بقاعدة البيانات SQL Server مباشرة باستخدام مكتبة `mssql`**
│   │   ├── logger.ts             # أداة تسجيل بسيطة (console)
│   │   └── utils.ts              # وظائف مساعدة عامة (مثل `cn` لدمج أصناف Tailwind)
│   ├── middleware.ts             # ملف الوسيط (Middleware) في Next.js (يستخدم للمصادقة على مستوى الطلب)
│   ├── providers/                # مجلد لمزودات السياق (React Context Providers)
│   │   ├── AppProviders.tsx      # مزود يجمع المزودات الأخرى (Theme, Language, Auth, Tooltip)
│   │   ├── AuthProvider.tsx      # مزود لإدارة حالة المصادقة للمستخدم
│   │   └── LanguageProvider.tsx  # مزود لإدارة اللغة الحالية (عربي/إنجليزي) واتجاه النص
│   └── types/                    # مجلد لتعريفات TypeScript المشتركة
│       └── index.ts              # ملف رئيسي لتعريف الواجهات والأنواع (User, Product, Category, Invoice etc.)
├── .env.local                    # (يجب إنشاؤه يدوياً) ملف متغيرات البيئة (DB_SERVER, DB_DATABASE, JWT_SECRET, etc.)
├── apphosting.yaml               # ملف إعدادات Firebase App Hosting
├── components.json               # ملف إعدادات ShadCN UI
├── install_dependencies.bat      # سكريبت دفعي محدث لتثبيت تبعيات Node.js فقط (`npm install`)
├── next.config.ts                # ملف إعدادات Next.js
├── package.json                  # ملف يصف المشروع، اعتماداته (بما في ذلك `mssql`), والسكريبتات
├── package-lock.json             # (يتم إنشاؤه بواسطة npm لتتبع شجرة الاعتماديات الدقيقة)
├── README.md                     # ملف يحتوي على معلومات عن المشروع
├── run_project.bat               # سكريبت دفعي محدث لتشغيل مشروع Next.js فقط (`npm run dev`)
└── tsconfig.json                 # ملف إعدادات TypeScript للمشروع (تم تصحيحه)
```

## ثانياً: شرح المجلدات والملفات الرئيسية (بعد التعديل)

*   **`src/lib/db.ts`**: تم تعديله بالكامل ليتصل مباشرة بقاعدة بيانات SQL Server باستخدام مكتبة `mssql`. يقرأ إعدادات الاتصال من ملف `.env.local`. **لم يعد هناك أي اعتماد على Python.**
*   **`src/scripts/db_bridge.py`**: **تم حذفه/إفراغه.**
*   **`requirements.txt`**: **تم حذفه/إفراغه.**
*   **`install_dependencies.bat`**: تم تبسيطه ليقوم فقط بتثبيت تبعيات Node.js (`npm install`).
*   **`run_project.bat`**: تم تبسيطه ليقوم فقط بتشغيل خادم تطوير Next.js (`npm run dev`).
*   **`.env.local`**: أصبح أكثر أهمية لأنه يحتوي الآن على جميع متغيرات البيئة اللازمة للاتصال المباشر بقاعدة البيانات بواسطة `mssql`.

## ثالثاً: أين وصلنا في المشروع الآن؟ (بعد التحول إلى Node.js/mssql)

1.  **أساسيات الواجهة والتصميم:** (كما كانت، لا تغييرات كبيرة هنا)
    *   اللغة العربية هي الافتراضية مع دعم RTL، وإمكانية التبديل للإنجليزية.
    *   دعم الوضع الليلي/النهاري.
    *   هيكل توجيه منظم مع تخطيط مخصص للصفحات الداخلية (شريط جانبي أيمن، رأس صفحة).
    *   صفحة تسجيل دخول احترافية (`/login`) باللغة العربية، باسم "محاسبي" من "مجموعة الوسيط جروب".

2.  **المصادقة وتسجيل الدخول:**
    *   صفحة تسجيل الدخول (`/login`) تتصل بواجهة خلفية (`/api/auth/login`) للتحقق من المستخدم.
    *   نقطة نهاية تسجيل الدخول (`/api/auth/login/route.ts`) **تستخدم الآن `src/lib/db.ts` (المعتمد على `mssql`) للاتصال المباشر بقاعدة البيانات** للتحقق من المستخدم ومقارنة كلمة المرور باستخدام `bcrypt.compare`.
    *   نقطة نهاية تسجيل مستخدم جديد (`/api/auth/register/route.ts`) تستخدم `bcrypt.hash` وتتصل مباشرة بقاعدة البيانات.
    *   يتم استخدام توكنات JWT (مع `jose`) وتخزينها في كوكيز HTTPOnly و localStorage.
    *   حماية المسارات تتم عبر الوسيط (`src/middleware.ts`).
    *   `AuthProvider` يدير حالة المستخدم في الواجهة الأمامية.

3.  **وحدة المنتجات:**
    *   الواجهة الأمامية (`src/app/(app)/products/page.tsx`) تستخدم `React Query (TanStack Query)`، وتتضمن نماذج للإضافة والتعديل (مع حقول موسعة)، وحالات تحميل، وتنبيهات `Toast`.
    *   تم إنشاء هياكل API أولية للمنتجات والفئات (ببيانات وهمية في `src/app/api/`) وهي جاهزة للربط بالمنطق الجديد في `db.ts` (المعتمد على `mssql`).

4.  **الاتصال بقاعدة البيانات:**
    *   **تم التحول بالكامل إلى الاتصال المباشر بـ SQL Server من داخل تطبيق Next.js باستخدام مكتبة `mssql`** (عبر `src/lib/db.ts`).
    *   **تم إلغاء أي اعتماد على Python.**
    *   **المشكلة الرئيسية الآن** هي ضمان أن `src/lib/db.ts` يتصل بنجاح بقاعدة البيانات وأن نقاط نهاية API (مثل تسجيل الدخول والمنتجات) تستخدمه بشكل صحيح. هذا يتطلب إعداد ملف `.env.local` بشكل صحيح والتأكد من أن خادم SQL Server متاح.

5.  **سكريبتات التشغيل:**
    *   تم تبسيطها بشكل كبير. `install_dependencies.bat` يثبت فقط تبعيات Node. `run_project.bat` يشغل فقط خادم Next.js.

## رابعاً: الخطوات اللازمة والمتبقية لإنجاز المشروع

1.  **ضمان نجاح الاتصال المباشر بقاعدة البيانات (أولوية قصوى):**
    *   **إنشاء وإعداد ملف `.env.local` بشكل صحيح** مع جميع متغيرات البيئة اللازمة للاتصال بـ SQL Server باستخدام `mssql` (اسم الخادم، القاعدة، المستخدم، كلمة المرور إذا لم تكن مصادقة Windows، المنفذ، إلخ).
    *   اختبار الاتصال بقاعدة البيانات من خلال نقطة نهاية تسجيل الدخول. يجب أن تكون قادرة على جلب المستخدم والتحقق من كلمة المرور باستخدام `src/lib/db.ts` الجديد.
    *   تشغيل سكريبت `scripts/update-admin-password.ts` (بعد التأكد من أن `db.ts` يعمل) لإنشاء/تحديث المستخدم المسؤول في قاعدة البيانات.

2.  **استكمال بناء الواجهة الخلفية لوحدة المنتجات (باستخدام `mssql`):**
    *   ربط نقاط نهاية API للمنتجات (`/api/products/route.ts` و `/api/products/[productId]/route.ts`) بالمنطق في `src/lib/db.ts` لتنفيذ عمليات (SELECT, INSERT, UPDATE, DELETE) على جدول المنتجات.
    *   تطبيق التحقق من صحة البيانات من جانب الخادم (Server-side Validation).

3.  **استكمال بناء الواجهة الخلفية لوحدة الفئات (Categories) (باستخدام `mssql`):**
    *   تطبيق نفس الخطوات المذكورة للمنتجات على نقاط نهاية API الخاصة بالفئات.

4.  **ربط الواجهة الأمامية للمنتجات والفئات بالـ API الحقيقي:**
    *   بمجرد جاهزية نقاط نهاية API الحقيقية (المتصلة بـ `mssql`)، يجب تحديث دوال `fetch` في `src/app/(app)/products/page.tsx` لاستدعاء هذه النقاط.
    *   اختبار عمليات CRUD للمنتجات والفئات بشكل كامل من الواجهة.
    *   التأكد من أن القائمة المنسدلة للفئات في نموذج المنتج تعمل بالبيانات الحقيقية.

5.  **تطوير بقية الوحدات الأساسية (تدريجياً وبنفس المنهجية - API ثم واجهة):**
    *   وحدة نقطة البيع (POS): ربطها بقائمة المنتجات الحقيقية، حفظ الفواتير في قاعدة البيانات، وتحديث المخزون تلقائياً عند البيع.
    *   وحدات المبيعات، المشتريات، المخزون، العملاء، الموردين.
    *   الوحدات المالية (دليل الحسابات، قيود اليومية).
    *   وحدة التقارير.

6.  **التحسينات والإضافات:**
    *   تحسين معالجة الأخطاء وتجربة المستخدم.
    *   إضافة ميزات متقدمة حسب الحاجة (مثل البحث المتقدم، التصفية، التصدير).
    *   كتابة اختبارات.
    *   مراجعة الأمان بشكل دوري.

أتمنى أن يكون هذا التحديث شاملاً ويوفر لكِ الوضوح اللازم يا شريكتي. إلغاء Python والاعتماد على `mssql` مباشرة سيبسط الأمور كثيراً بمجرد أن نتأكد من أن الاتصال المباشر يعمل بثبات.

إلى الأمام دائماً!

    