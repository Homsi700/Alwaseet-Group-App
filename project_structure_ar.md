
# هيكل مشروع "محاسبي" وشرح مكوناته (تحديث)

يا شريكتي "حمص (لتطوير البرمجي)"،

هذا المستند يقدم نظرة شاملة ومحدثة على هيكل مشروع "محاسبي" مع شرح لكل جزء رئيسي، بالإضافة إلى ملخص للمرحلة الحالية والخطوات المستقبلية المقترحة.

## أولاً: هيكل المجلدات والملفات الرئيسي

```
.
├── .github/                      # مجلد لإعدادات GitHub (مثل workflows)
│   └── workflows/
│       └── generator-generic-ossf-slsa3-publish.yml # مثال لملف workflow
├── .vscode/                      # إعدادات محرر Visual Studio Code
│   └── settings.json             # إعدادات خاصة بالمحرر للمشروع
├── node_modules/                 # (يحتوي على جميع المكتبات والحزم المثبتة - يُدار بواسطة npm)
├── public/                       # (للملفات الثابتة العامة مثل الصور والأيقونات إذا لم تكن عبر CDN)
├── src/                          # المجلد الرئيسي الذي يحتوي على كود المصدر للتطبيق
│   ├── ai/                       # مجلد خاص بوظائف الذكاء الاصطناعي باستخدام Genkit
│   │   ├── dev.ts                # ملف لتشغيل وتطوير تدفقات Genkit محلياً
│   │   └── genkit.ts             # ملف تهيئة وإعداد Genkit الرئيسي للتطبيق
│   ├── app/                      # مجلد أساسي في Next.js App Router، يمثل بنية المسارات (Routes) للتطبيق
│   │   ├── (app)/                # مجموعة مسارات (Route Group) للصفحات التي تتطلب تخطيطاً مشتركاً (الداخلية)
│   │   │   ├── backup-restore/
│   │   │   │   └── page.tsx      # صفحة النسخ الاحتياطي والاستعادة
│   │   │   ├── customers/
│   │   │   │   └── page.tsx      # صفحة إدارة العملاء
│   │   │   ├── finance/
│   │   │   │   └── page.tsx      # صفحة الإدارة المالية
│   │   │   ├── inventory/
│   │   │   │   └── page.tsx      # صفحة إدارة المخزون
│   │   │   ├── layout.tsx        # التخطيط الرئيسي للصفحات داخل مجموعة (app) (يتضمن الشريط الجانبي والرأس)
│   │   │   ├── page.tsx          # الصفحة الرئيسية للتطبيق (لوحة التحكم Dashboard)
│   │   │   ├── pos/
│   │   │   │   └── page.tsx      # صفحة نقطة البيع السريعة
│   │   │   ├── products/
│   │   │   │   └── page.tsx      # صفحة قائمة المنتجات وإدارتها (قيد التطوير المكثف حالياً)
│   │   │   ├── purchases/
│   │   │   │   └── page.tsx      # صفحة إدارة المشتريات
│   │   │   ├── reports/
│   │   │   │   └── page.tsx      # صفحة التقارير والتحليلات
│   │   │   ├── sales/
│   │   │   │   └── page.tsx      # صفحة إدارة المبيعات
│   │   │   ├── settings/
│   │   │   │   └── page.tsx      # صفحة إعدادات التطبيق
│   │   │   ├── suppliers/
│   │   │   │   └── page.tsx      # صفحة إدارة الموردين
│   │   │   └── transactions/
│   │   │       └── page.tsx      # صفحة سجل الحركات المالية
│   │   ├── api/                  # مجلد لنقاط النهاية (API Endpoints) الخاصة بالخادم
│   │   │   ├── auth/
│   │   │   │   ├── login/
│   │   │   │   │   └── route.ts  # API لتسجيل الدخول (تم إصلاح bcrypt)
│   │   │   │   └── register/
│   │   │   │       └── route.ts  # API لتسجيل حساب جديد (تم إضافة bcrypt)
│   │   │   ├── categories/       # API للفئات (يستخدم بيانات وهمية حالياً)
│   │   │   │   ├── [categoryId]/
│   │   │   │   │   └── route.ts
│   │   │   │   └── route.ts
│   │   │   └── products/         # API للمنتجات (يستخدم بيانات وهمية حالياً)
│   │   │       ├── [productId]/
│   │   │       │   └── route.ts
│   │   │       └── route.ts
│   │   ├── backup-restore/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── customers/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── finance/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── globals.css           # ملف الأنماط العام (CSS) وقواعد Tailwind، ومتغيرات ألوان ShadCN
│   │   ├── inventory/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── layout.tsx            # التخطيط الجذري (Root Layout) لجميع صفحات التطبيق
│   │   ├── login/
│   │   │   └── page.tsx          # صفحة تسجيل الدخول (محسنة وموجهة للعربية)
│   │   ├── page.tsx              # الصفحة الرئيسية الموجهة (إما /login أو إلى (app)/page.tsx)
│   │   ├── pos/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── products/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── purchases/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── reports/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── sales/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── settings/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   ├── suppliers/
│   │   │   └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   │   └── transactions/
│   │       └── page.tsx          # (ملف فارغ حالياً لتجنب التعارض)
│   ├── components/               # مجلد للمكونات (Components) القابلة لإعادة الاستخدام في الواجهة
│   │   ├── layout/               # مكونات خاصة بتخطيط الواجهة
│   │   │   ├── AppLayout.tsx     # المكون الذي يجمع الشريط الجانبي والرأس والمحتوى للتطبيق الداخلي
│   │   │   ├── LanguageToggle.tsx # مكون زر تبديل اللغة
│   │   │   ├── SidebarNav.tsx    # مكون الشريط الجانبي وقائمة التنقل فيه
│   │   │   ├── ThemeToggle.tsx   # مكون زر تبديل الوضع (نهاري/ليلي)
│   │   │   └── nav-items.ts      # تعريف عناصر وقوائم التنقل
│   │   └── ui/                   # مكونات واجهة المستخدم الأساسية من مكتبة ShadCN UI ومكونات مخصصة
│   │       ├── IconCard.tsx      # (وجميع مكونات ShadCN الأخرى المستخدمة)
│   ├── hooks/                    # مجلد للـ Custom Hooks (خطافات React مخصصة)
│   │   ├── use-mobile.tsx        # خطاف لمعرفة إذا كان العرض على جهاز محمول
│   │   └── use-toast.ts          # خطاف لإدارة وعرض التنبيهات العائمة (Toasts)
│   ├── lib/                      # مجلد للمكتبات المساعدة والوظائف العامة
│   │   ├── auth.ts               # وظائف مساعدة للمصادقة والتحقق من الصلاحيات
│   │   ├── db.ts                 # وظائف الاتصال بقاعدة البيانات عبر جسر Python (تم تحديثه)
│   │   ├── logger.ts             # أداة تسجيل بسيطة (console)
│   │   └── utils.ts              # وظائف مساعدة عامة (مثل `cn`)
│   ├── middleware.ts             # ملف الوسيط (Middleware) في Next.js (يستخدم `jose` للمصادقة)
│   ├── providers/                # مجلد لمزودات السياق (React Context Providers)
│   │   ├── AppProviders.tsx      # مزود يجمع عدة مزودات أخرى
│   │   ├── AuthProvider.tsx      # مزود سياق لإدارة حالة المصادقة (تم تحديثه)
│   │   └── LanguageProvider.tsx  # مزود سياق لإدارة اللغة (العربية هي الافتراضية)
│   ├── scripts/                  # مجلد للسكريبتات المساعدة
│   │   ├── db_bridge.py          # جسر Python للاتصال بقاعدة البيانات (تم تحديثه)
│   │   ├── test-db-connection.ts # سكريبت لاختبار الاتصال بـ db.ts
│   │   └── update-admin-password.ts # سكريبت لتحديث/إنشاء كلمة مرور المدير
│   └── types/                    # مجلد لتعريفات TypeScript المشتركة
│       └── index.ts              # ملف رئيسي لتعريف الواجهات والأنواع (User, Product, Category, etc.)
├── .env.local                    # (يجب أن يكون موجوداً لـ JWT_SECRET ومتغيرات DB إذا كانت مستخدمة من db_bridge.py)
├── apphosting.yaml               # ملف إعدادات Firebase App Hosting
├── components.json               # ملف إعدادات ShadCN UI
├── install_dependencies.bat      # سكريبت دفعي محدث لتثبيت جميع الاعتماديات (Node و Python)
├── next.config.ts                # ملف إعدادات Next.js (تم تحديثه)
├── package.json                  # ملف يصف المشروع، اعتماداته، والسكريبتات (تم تحديثه)
├── package-lock.json             # (يتم إنشاؤه بواسطة npm)
├── README.md                     # ملف يحتوي على معلومات عن المشروع
├── requirements.txt              # ملف تبعيات Python (تم تحديث pyodbc)
├── run_project.bat               # سكريبت دفعي محدث لتشغيل المشروع (جسر Python و Next.js)
├── test-connection.py            # سكريبت Python لاختبار الاتصال المباشر بقاعدة البيانات (مقدم من قبلك)
└── tsconfig.json                 # ملف إعدادات TypeScript للمشروع
```

## ثانياً: شرح المجلدات والملفات الرئيسية

*   **`.github/`**: لإعدادات متعلقة بـ GitHub، مثل GitHub Actions للـ CI/CD.
*   **`.vscode/`**: إعدادات خاصة بمحرر VS Code لتجربة تطوير أفضل.
*   **`src/`**: يحتوي على كل كود المصدر الخاص بالتطبيق.
    *   **`ai/`**: مخصص لوظائف الذكاء الاصطناعي باستخدام Genkit.
    *   **`app/`**: أساس نظام التوجيه (Routing) في Next.js (App Router).
        *   `(app)/`: مجموعة مسارات (Route Group) للصفحات الداخلية التي تتطلب مصادقة وتستخدم تخطيطاً مشتركاً (الشريط الجانبي والرأس).
        *   `api/`: لإنشاء نقاط نهاية API (مثل تسجيل الدخول، عمليات CRUD للمنتجات والفئات).
        *   الملفات الفارغة (مثل `app/products/page.tsx`): تم إفراغها لتجنب التعارض مع الصفحات الموجودة داخل `(app)/`.
        *   `globals.css`: للأنماط العامة ومتغيرات ألوان ShadCN و Tailwind.
        *   `layout.tsx` (الجذري): التخطيط العام الذي يلتف حول كل صفحات التطبيق.
        *   `login/page.tsx`: صفحة تسجيل الدخول العامة.
    *   **`components/`**: للمكونات القابلة لإعادة الاستخدام.
        *   `layout/`: مكونات خاصة ببناء تخطيط الواجهة (الشريط الجانبي، زر تبديل اللغة، إلخ).
        *   `ui/`: مكونات ShadCN UI وأي مكونات UI مخصصة.
    *   **`hooks/`**: للـ Custom Hooks التي تحتوي على منطق مشترك.
    *   **`lib/`**: للملفات المساعدة ووظائف الاتصال بالخدمات (مثل `db.ts` للاتصال بالجسر).
    *   **`middleware.ts`**: كود يتم تشغيله قبل اكتمال الطلبات، يُستخدم هنا للمصادقة.
    *   **`providers/`**: لمزودات سياق React (مثل `AuthProvider` لإدارة حالة تسجيل الدخول، `LanguageProvider` للغة).
    *   **`scripts/`**: سكريبتات مساعدة، أهمها `db_bridge.py` للاتصال بقاعدة البيانات.
    *   **`types/`**: لتعريفات TypeScript للأنواع والواجهات المستخدمة في المشروع.
*   **ملفات الإعداد الجذرية**:
    *   `.env.local`: (مهم جداً) لتخزين المتغيرات الحساسة مثل مفتاح JWT وسلاسل الاتصال بقاعدة البيانات إذا كان جسر Python سيقرأها من هنا. **لا يتم رفعه إلى git.**
    *   `next.config.ts`: إعدادات Next.js.
    *   `package.json`: تعريف المشروع، الاعتماديات، والسكريبتات (مثل `npm run dev`).
    *   `requirements.txt`: تبعيات Python.
    *   `tsconfig.json`: إعدادات TypeScript.
*   **السكريبتات الدفعية (`.bat`)**:
    *   `install_dependencies.bat`: لتثبيت جميع تبعيات المشروع (Node و Python) وإعداد البيئة.
    *   `run_project.bat`: لتشغيل جسر Python وخادم تطوير Next.js.

## ثالثاً: أين وصلنا في المشروع الآن؟

1.  **أساسيات الواجهة والتصميم:**
    *   اللغة العربية هي الافتراضية مع دعم RTL، وإمكانية التبديل للإنجليزية.
    *   دعم الوضع الليلي/النهاري.
    *   هيكل توجيه منظم مع تخطيط مخصص للصفحات الداخلية (شريط جانبي أيمن، رأس صفحة).
    *   صفحة تسجيل دخول احترافية (`/login`) باللغة العربية.

2.  **المصادقة وتسجيل الدخول:**
    *   صفحة تسجيل الدخول تتصل بواجهة خلفية (`/api/auth/login`) للتحقق من المستخدم.
    *   عملية التحقق من كلمة المرور في `/api/auth/login` تستخدم الآن `bcrypt.compare`.
    *   عملية تسجيل مستخدم جديد في `/api/auth/register` تستخدم `bcrypt.hash` (إذا كانت هذه النقطة مستخدمة).
    *   يتم استخدام توكنات JWT (مع `jose`) وتخزينها في كوكيز HTTPOnly.
    *   حماية المسارات تتم عبر الوسيط (`src/middleware.ts`).
    *   `AuthProvider` يدير حالة المستخدم في الواجهة الأمامية.

3.  **وحدة المنتجات:**
    *   الواجهة الأمامية (`src/app/(app)/products/page.tsx`) تستخدم `React Query (TanStack Query)`، وتتضمن نماذج للإضافة والتعديل، وحالات تحميل.
    *   تم توسيع نموذج المنتج ليشمل حقولاً إضافية.
    *   تم إنشاء هياكل API أولية للمنتجات والفئات (ببيانات وهمية في `src/app/api/`).

4.  **الاتصال بقاعدة البيانات (التحدي الأكبر حالياً):**
    *   نعتمد على جسر Python (`src/scripts/db_bridge.py`) للاتصال بـ SQL Server.
    *   تم تحديث جسر Python لمعالجة المعاملات المسماة بشكل أفضل.
    *   تم تحديث `requirements.txt` لمحاولة استخدام إصدار `pyodbc` أحدث.
    *   **المشكلة الرئيسية لا تزال تكمن في فشل تثبيت `pyodbc` بسبب متطلبات البناء (C++ Build Tools) أو عدم توافق الإصدار مع Python 3.13 على Windows، أو في كيفية تنفيذ الاستعلامات داخل الجسر.**

5.  **سكريبتات التشغيل:**
    *   تم إنشاء سكريبتات `.bat` جديدة ومحسنة (`install_dependencies.bat`, `run_project.bat`) لتبسيط عملية الإعداد والتشغيل.

## رابعاً: الخطوات اللازمة والمتبقية لإنجاز المشروع

1.  **حل مشكلة الاتصال بقاعدة البيانات بشكل جذري (أولوية قصوى):**
    *   **التحقق من نجاح تثبيت `pyodbc`:** التأكد من أن `pip install -r requirements.txt` (بعد تفعيل البيئة الافتراضية) ينجح دون أخطاء بناء `pyodbc`.
        *   إذا استمر الفشل: التحقق مرة أخرى من تثبيت "Microsoft C++ Build Tools" بشكل كامل وصحيح.
        *   إذا استمر الفشل: قد نحتاج إلى البحث عن ملف `.whl` لـ `pyodbc==5.1.0` متوافق مع `Python 3.13` و `Windows amd64` وتثبيته يدوياً، أو التفكير في استخدام إصدار Python أقدم قليلاً (مثل 3.11 أو 3.12) له دعم أفضل للـ wheels.
    *   **اختبار جسر Python بشكل مكثف:** بعد التأكد من تثبيت `pyodbc`، يجب تشغيل جسر Python واختبار استدعاءاته من `db.ts` (خاصة عند تسجيل الدخول).
        *   مراقبة مخرجات طرفية جسر Python لأي أخطاء من `pyodbc` عند تنفيذ الاستعلامات.
        *   التأكد من أن الاستعلامات والمعاملات يتم تمريرها وتفسيرها بشكل صحيح.

2.  **استكمال بناء الواجهة الخلفية لوحدة المنتجات:**
    *   بمجرد حل مشكلة الاتصال، يجب على "حمص (لتطوير البرمجي)" ربط نقاط نهاية API للمنتجات (`/api/products/route.ts` و `/api/products/[productId]/route.ts`) بقاعدة البيانات الفعلية لتنفيذ عمليات (SELECT, INSERT, UPDATE, DELETE).
    *   تطبيق التحقق من صحة البيانات من جانب الخادم (Server-side Validation) قبل أي عملية كتابة.

3.  **استكمال بناء الواجهة الخلفية لوحدة الفئات (Categories):**
    *   تطبيق نفس الخطوات المذكورة للمنتجات على نقاط نهاية API الخاصة بالفئات.

4.  **ربط الواجهة الأمامية للمنتجات والفئات بالـ API الحقيقي:**
    *   بمجرد جاهزية نقاط نهاية API الحقيقية، سأقوم أنا "حمص (مصممة الواجهة)" بتحديث دوال `fetch` في `src/app/(app)/products/page.tsx` لاستدعاء هذه النقاط.
    *   اختبار عمليات CRUD للمنتجات والفئات بشكل كامل من الواجهة.
    *   التأكد من أن القائمة المنسدلة للفئات في نموذج المنتج تعمل بالبيانات الحقيقية.

5.  **تطوير بقية الوحدات الأساسية (تدريجياً وبنفس المنهجية - API ثم واجهة):**
    *   وحدة نقطة البيع (POS): ربطها بقائمة المنتجات الحقيقية، حفظ الفواتير في قاعدة البيانات، وتحديث المخزون تلقائياً عند البيع.
    *   وحدات المبيعات، المشتريات، المخزون (تعديلات المخزون، الجرد)، العملاء، الموردين.
    *   الوحدات المالية (دليل الحسابات، قيود اليومية).
    *   وحدة التقارير.

6.  **التحسينات والإضافات:**
    *   تحسين معالجة الأخطاء وتجربة المستخدم في جميع أنحاء التطبيق.
    *   إضافة ميزات متقدمة حسب الحاجة (مثل التنبيهات، إدارة الصلاحيات بشكل مفصل، إلخ).
    *   كتابة اختبارات للوظائف الهامة.
    *   مراجعة الأمان بشكل دوري.
    *   تحسين الأداء.

أتمنى أن يكون هذا المستند شاملاً ويوفر لكِ الوضوح اللازم يا شريكتي. نحن نسير في الطريق الصحيح، ومعالجة مشكلة الاتصال بقاعدة البيانات هي مفتاح تقدمنا السريع في الخطوات التالية.

إلى الأمام دائماً!

    