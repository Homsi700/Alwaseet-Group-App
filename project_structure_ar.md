
# هيكل مشروع "محاسبي" وشرح مكوناته (تحديث بعد إلغاء Python)

يا شريكتي "حمص (لتطوير البرمجي)"،

هذا المستند يقدم نظرة شاملة ومحدثة على هيكل مشروع "محاسبي" مع شرح لكل جزء رئيسي، مع الأخذ في الاعتبار **إلغاء الاعتماد على جسر Python والتحول إلى الاتصال المباشر بقاعدة بيانات SQL Server باستخدام مكتبة `mssql` من داخل Node.js/Next.js.**

## أولاً: هيكل المجلدات والملفات الرئيسي (بعد التعديل)

```
.
├── .github/                      # مجلد لإعدادات GitHub (مثل workflows)
│   └── workflows/
│       └── generator-generic-ossf-slsa3-publish.yml
├── .vscode/                      # إعدادات محرر Visual Studio Code
│   └── settings.json
├── node_modules/                 # (يحتوي على جميع المكتبات والحزم المثبتة - يُدار بواسطة npm)
├── public/                       # (للملفات الثابتة العامة)
├── scripts/                      # مجلد للسكريبتات المساعدة (TypeScript)
│   └── update-admin-password.ts  # سكريبت لتحديث/إنشاء كلمة مرور المدير (يستخدم db.ts الجديد)
├── src/                          # المجلد الرئيسي الذي يحتوي على كود المصدر للتطبيق
│   ├── ai/                       # مجلد خاص بوظائف الذكاء الاصطناعي باستخدام Genkit
│   │   ├── dev.ts
│   │   └── genkit.ts
│   ├── app/                      # مجلد أساسي في Next.js App Router، يمثل بنية المسارات
│   │   ├── (app)/                # مجموعة مسارات للصفحات الداخلية (بعد تسجيل الدخول)
│   │   │   ├── backup-restore/
│   │   │   │   └── page.tsx
│   │   │   ├── customers/
│   │   │   │   └── page.tsx
│   │   │   ├── finance/
│   │   │   │   └── page.tsx
│   │   │   ├── inventory/
│   │   │   │   └── page.tsx
│   │   │   ├── layout.tsx        # التخطيط الرئيسي للصفحات داخل (app)
│   │   │   ├── page.tsx          # الصفحة الرئيسية للتطبيق (لوحة التحكم)
│   │   │   ├── pos/
│   │   │   │   └── page.tsx
│   │   │   ├── products/
│   │   │   │   └── page.tsx      # (قيد التطوير المكثف للربط بالـ API)
│   │   │   ├── purchases/
│   │   │   │   └── page.tsx
│   │   │   ├── reports/
│   │   │   │   └── page.tsx
│   │   │   ├── sales/
│   │   │   │   └── page.tsx
│   │   │   ├── settings/
│   │   │   │   └── page.tsx
│   │   │   ├── suppliers/
│   │   │   │   └── page.tsx
│   │   │   └── transactions/
│   │   │       └── page.tsx
│   │   ├── api/                  # مجلد لنقاط النهاية (API Endpoints)
│   │   │   ├── auth/
│   │   │   │   ├── login/
│   │   │   │   │   └── route.ts  # API لتسجيل الدخول (يستخدم db.ts الجديد)
│   │   │   │   └── register/
│   │   │   │       └── route.ts  # API لتسجيل حساب جديد (يستخدم db.ts الجديد)
│   │   │   ├── categories/       # API للفئات (يستخدم بيانات وهمية حالياً، سيتم ربطه بـ db.ts)
│   │   │   │   ├── [categoryId]/
│   │   │   │   │   └── route.ts
│   │   │   │   └── route.ts
│   │   │   └── products/         # API للمنتجات (يستخدم بيانات وهمية حالياً، سيتم ربطه بـ db.ts)
│   │   │       ├── [productId]/
│   │   │       │   └── route.ts
│   │   │       └── route.ts
│   │   ├── backup-restore/       # (ملفات فارغة لتجنب التعارض، المسار الصحيح داخل (app))
│   │   │   └── page.tsx
│   │   ├── (بقية المجلدات الفارغة المشابهة: customers, finance, etc.)
│   │   ├── globals.css           # الأنماط العامة ومتغيرات ShadCN
│   │   ├── layout.tsx            # التخطيط الجذري لجميع صفحات التطبيق
│   │   ├── login/
│   │   │   └── page.tsx          # صفحة تسجيل الدخول
│   │   └── page.tsx              # الصفحة الرئيسية الموجهة
│   ├── components/               # مجلد للمكونات القابلة لإعادة الاستخدام
│   │   ├── layout/               # مكونات خاصة بتخطيط الواجهة
│   │   │   ├── AppLayout.tsx
│   │   │   ├── LanguageToggle.tsx
│   │   │   ├── SidebarNav.tsx
│   │   │   ├── ThemeToggle.tsx
│   │   │   └── nav-items.ts
│   │   └── ui/                   # مكونات واجهة المستخدم من ShadCN UI ومكونات مخصصة
│   │       ├── IconCard.tsx
│   │       ├── (وجميع مكونات ShadCN الأخرى المستخدمة)
│   ├── hooks/                    # مجلد للـ Custom Hooks
│   │   ├── use-mobile.tsx
│   │   └── use-toast.ts
│   ├── lib/                      # مجلد للمكتبات المساعدة والوظائف العامة
│   │   ├── auth.ts               # وظائف مساعدة للمصادقة
│   │   ├── db.ts                 # وظائف الاتصال بقاعدة البيانات (SQL Server باستخدام mssql)
│   │   ├── logger.ts             # أداة تسجيل بسيطة (console)
│   │   └── utils.ts              # وظائف مساعدة عامة (مثل `cn`)
│   ├── middleware.ts             # ملف الوسيط (Middleware) في Next.js (للمصادقة)
│   ├── providers/                # مجلد لمزودات السياق (React Context Providers)
│   │   ├── AppProviders.tsx
│   │   ├── AuthProvider.tsx
│   │   └── LanguageProvider.tsx
│   └── types/                    # مجلد لتعريفات TypeScript المشتركة
│       └── index.ts
├── .env.local                    # (مهم جداً) ملف متغيرات البيئة (DB_SERVER, DB_DATABASE, JWT_SECRET, etc.)
├── apphosting.yaml               # ملف إعدادات Firebase App Hosting
├── components.json               # ملف إعدادات ShadCN UI
├── install_dependencies.bat      # سكريبت دفعي محدث لتثبيت تبعيات Node.js فقط
├── next.config.ts                # ملف إعدادات Next.js
├── package.json                  # ملف يصف المشروع، اعتماداته، والسكريبتات (تم تحديثه ليشمل mssql)
├── package-lock.json             # (يتم إنشاؤه بواسطة npm)
├── README.md                     # ملف يحتوي على معلومات عن المشروع
├── run_project.bat               # سكريبت دفعي محدث لتشغيل مشروع Next.js فقط
└── tsconfig.json                 # ملف إعدادات TypeScript للمشروع
```

## ثانياً: شرح المجلدات والملفات الرئيسية (بعد التعديل)

*   **`scripts/`**: يحتوي الآن على سكريبتات TypeScript (مثل `update-admin-password.ts`) التي يمكن تشغيلها باستخدام `tsx`. لم يعد هناك حاجة لسكريبتات Python.
*   **`src/lib/db.ts`**: تم تعديله بالكامل ليتصل مباشرة بقاعدة بيانات SQL Server باستخدام مكتبة `mssql`. يقرأ إعدادات الاتصال من ملف `.env.local`.
*   **`src/scripts/db_bridge.py`**: **تم حذفه/إفراغه.** لم نعد نستخدم جسر Python.
*   **`requirements.txt`**: **تم حذفه/إفراغه.** لم نعد نستخدم تبعيات Python.
*   **`install_dependencies.bat`**: تم تبسيطه ليقوم فقط بتثبيت تبعيات Node.js (`npm install`).
*   **`run_project.bat`**: تم تبسيطه ليقوم فقط بتشغيل خادم تطوير Next.js (`npm run dev`).
*   **`.env.local`**: أصبح أكثر أهمية لأنه يحتوي الآن على جميع متغيرات البيئة اللازمة للاتصال المباشر بقاعدة البيانات.

## ثالثاً: أين وصلنا في المشروع الآن؟ (بعد التعديل)

1.  **أساسيات الواجهة والتصميم:** (كما كانت، لا تغييرات كبيرة هنا)
    *   اللغة العربية هي الافتراضية مع دعم RTL، وإمكانية التبديل للإنجليزية.
    *   دعم الوضع الليلي/النهاري.
    *   هيكل توجيه منظم مع تخطيط مخصص للصفحات الداخلية (شريط جانبي أيمن، رأس صفحة).
    *   صفحة تسجيل دخول احترافية (`/login`) باللغة العربية.

2.  **المصادقة وتسجيل الدخول:**
    *   صفحة تسجيل الدخول (`/login`) تتصل بواجهة خلفية (`/api/auth/login`) للتحقق من المستخدم.
    *   نقطة نهاية تسجيل الدخول (`/api/auth/login/route.ts`) **تستخدم الآن `src/lib/db.ts` (المعتمد على `mssql`) للاتصال المباشر بقاعدة البيانات** للتحقق من المستخدم ومقارنة كلمة المرور باستخدام `bcrypt.compare`.
    *   نقطة نهاية تسجيل مستخدم جديد (`/api/auth/register/route.ts`) تستخدم `bcrypt.hash` وتتصل مباشرة بقاعدة البيانات.
    *   يتم استخدام توكنات JWT (مع `jose`) وتخزينها في كوكيز HTTPOnly و localStorage.
    *   حماية المسارات تتم عبر الوسيط (`src/middleware.ts`).
    *   `AuthProvider` يدير حالة المستخدم في الواجهة الأمامية.

3.  **وحدة المنتجات:**
    *   الواجهة الأمامية (`src/app/(app)/products/page.tsx`) تستخدم `React Query (TanStack Query)`، وتتضمن نماذج للإضافة والتعديل (مع حقول موسعة)، وحالات تحميل.
    *   تم إنشاء هياكل API أولية للمنتجات والفئات (ببيانات وهمية في `src/app/api/`) وهي جاهزة للربط بالمنطق الجديد في `db.ts`.

4.  **الاتصال بقاعدة البيانات:**
    *   **تم التحول بالكامل إلى الاتصال المباشر بـ SQL Server من داخل تطبيق Next.js باستخدام مكتبة `mssql`** (عبر `src/lib/db.ts`).
    *   **تم إلغاء الاعتماد على جسر Python.**
    *   **المشكلة الرئيسية الآن** هي ضمان أن `src/lib/db.ts` يتصل بنجاح بقاعدة البيانات وأن نقاط نهاية API (مثل تسجيل الدخول والمنتجات) تستخدمه بشكل صحيح.

5.  **سكريبتات التشغيل:**
    *   تم تبسيطها بشكل كبير. `install_dependencies.bat` يثبت فقط تبعيات Node. `run_project.bat` يشغل فقط خادم Next.js.

## رابعاً: الخطوات اللازمة والمتبقية لإنجاز المشروع

1.  **ضمان نجاح الاتصال المباشر بقاعدة البيانات (أولوية قصوى):**
    *   **إعداد ملف `.env.local` بشكل صحيح** مع جميع متغيرات البيئة اللازمة للاتصال بـ SQL Server (اسم الخادم، القاعدة، المستخدم، كلمة المرور إذا لم تكن مصادقة Windows، المنفذ، إلخ).
    *   اختبار الاتصال بقاعدة البيانات من خلال نقطة نهاية تسجيل الدخول. يجب أن تكون قادرة على جلب المستخدم والتحقق من كلمة المرور باستخدام `src/lib/db.ts` الجديد.
    *   تشغيل سكريبت `scripts/update-admin-password.ts` (بعد التأكد من أن `db.ts` يعمل) لإنشاء/تحديث المستخدم المسؤول في قاعدة البيانات.

2.  **استكمال بناء الواجهة الخلفية لوحدة المنتجات (باستخدام `mssql`):**
    *   ربط نقاط نهاية API للمنتجات (`/api/products/route.ts` و `/api/products/[productId]/route.ts`) بالمنطق في `src/lib/db.ts` لتنفيذ عمليات (SELECT, INSERT, UPDATE, DELETE) على جدول المنتجات.
    *   تطبيق التحقق من صحة البيانات من جانب الخادم (Server-side Validation).

3.  **استكمال بناء الواجهة الخلفية لوحدة الفئات (Categories) (باستخدام `mssql`):**
    *   تطبيق نفس الخطوات المذكورة للمنتجات على نقاط نهاية API الخاصة بالفئات.

4.  **ربط الواجهة الأمامية للمنتجات والفئات بالـ API الحقيقي:**
    *   بمجرد جاهزية نقاط نهاية API الحقيقية (المتصلة بـ `mssql`)، يجب تحديث دوال `fetch` في `src/app/(app)/products/page.tsx` لاستدعاء هذه النقاط.
    *   اختبار عمليات CRUD للمنتجات والفئات بشكل كامل من الواجهة.
    *   التأكد من أن القائمة المنسدلة للفئات في نموذج المنتج تعمل بالبيانات الحقيقية.

5.  **تطوير بقية الوحدات الأساسية (تدريجياً وبنفس المنهجية - API ثم واجهة):**
    *   وحدة نقطة البيع (POS): ربطها بقائمة المنتجات الحقيقية، حفظ الفواتير في قاعدة البيانات، وتحديث المخزون تلقائياً عند البيع.
    *   وحدات المبيعات، المشتريات، المخزون، العملاء، الموردين.
    *   الوحدات المالية (دليل الحسابات، قيود اليومية).
    *   وحدة التقارير.

6.  **التحسينات والإضافات:**
    *   تحسين معالجة الأخطاء وتجربة المستخدم.
    *   إضافة ميزات متقدمة حسب الحاجة.
    *   كتابة اختبارات.
    *   مراجعة الأمان.

أتمنى أن يكون هذا التحديث شاملاً ويوفر لكِ الوضوح اللازم يا شريكتي. إلغاء Python سيبسط الأمور كثيراً بمجرد أن نتأكد من أن الاتصال المباشر بـ `mssql` يعمل بثبات.

إلى الأمام دائماً!
